<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DastavejWizard</title>
    <style>
        :root {
            --primary-color: #10a37f;
            --primary-hover: #1a7f64;
            --secondary-color: #4b5563;
            --accent-color: #6366f1;
            --error-color: #ef4444;
            --bg-color: #f7f7f8;
            --card-bg: #ffffff;
            --chat-user-bg: #f8f8f8;
            --chat-assistant-bg: #ffffff;
            --text-color: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --sidebar-bg: #202123;
            --sidebar-text: #d9d9e3;
            --sidebar-hover: #2a2b32;
            --sidebar-width: 260px;
            --border-radius: 8px;
            --transition-speed: 0.3s;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* App Container */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
            position: relative;
        }
        .app-container.fullscreen-mode #sidebar {
            display: none;
        }

        .app-container.fullscreen-mode #main-content {
            width: 100% !important;
        }
        /* Sidebar */
        #sidebar {
            transition: all var(--transition-speed) ease;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.75rem;
            z-index: 100;
        }

        .sidebar-header {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .sidebar-section {
            margin-top: 0.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .section-header {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .sidebar-button {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background var(--transition-speed) ease;
            background: transparent;
            color: var(--sidebar-text);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            text-align: left;
            font-size: 0.9375rem;
        }

        .sidebar-button:hover {
            background-color: var(--sidebar-hover);
        }

        .sidebar-button.secondary {
            border: none;
        }

        .sidebar-footer {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0.75rem 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Chat Items */
        .chat-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: background var(--transition-speed) ease;
            font-size: 0.9375rem;
        }

        .chat-item:hover {
            background: var(--sidebar-hover);
        }

        .chat-item.active {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Main Content */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: margin-left var(--transition-speed) ease;
            width: calc(100% - var(--sidebar-width));
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Header */
        .header-container {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            box-shadow: var(--shadow-sm);
            gap: 1rem;
        }

        .header-menu-button {
            background: transparent;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 0.375rem;
        }

        .header-menu-button:hover {
            background-color: var(--chat-user-bg);
        }

        .header-title {
            font-size: 1rem;
            font-weight: 600;
            flex: 1;
        }

        .file-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background-color: var(--chat-user-bg);
            border-radius: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Welcome Screen */
        .welcome-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            max-width: 640px;
            margin: 0 auto;
            height: 100%;
        }

        .welcome-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
        }

        .logo-large {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .welcome-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .welcome-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 480px;
        }

        .welcome-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .welcome-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .welcome-button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .welcome-button.primary:hover {
            background-color: var(--primary-hover);
        }

        .welcome-button.secondary {
            background-color: var(--chat-user-bg);
            color: var(--text-color);
        }

        .welcome-button.secondary:hover {
            background-color: var(--border-color);
        }

        /* Chat Container */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            position: relative;
            scroll-behavior: smooth;
        }

        /* Chat Messages */
        #chatbot {
            width: 100%;
            max-height: 500px;
            max-width: 800px;
            height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
            margin: 0 auto;
            padding: 1rem 1rem 2rem 1rem;
        }

        .chat-turn {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
        }

        .user-message,
        .assistant-message {
            display: flex;
            padding: 1.5rem;
            gap: 1rem;
        }

        .user-message {
            background-color: var(--chat-user-bg);
        }

        .assistant-message {
            background-color: var(--chat-assistant-bg);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        .message-avatar {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 0.25rem;
            background-color: var(--secondary-color);
            color: white;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .user-message .message-avatar {
            background-color: var(--secondary-color);
        }

        .assistant-message .message-avatar {
            background-color: var(--primary-color);
        }

        .message-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message-content p {
            margin: 0;
        }

        /* Input Area */
        .input-area {
            padding: 1rem;
            background-color: var(--bg-color);
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }

        #input-container {
            display: flex;
            align-items: flex-end;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.75rem;
            box-shadow: var(--shadow-md);
            max-width: 800px;
            margin: 0 auto;
        }

        #message-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-color);
            font-size: 1rem;
            padding: 0.5rem;
            resize: none;
            max-height: 200px;
            font-family: inherit;
        }

        .input-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .icon-button {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .icon-button:hover {
            background-color: var(--chat-user-bg);
            color: var(--text-color);
        }

        .icon-button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .icon-button.primary:hover {
            background-color: var(--primary-hover);
        }

        .icon-button.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-footer {
            padding: 0.5rem;
            text-align: center;
            color: var(--text-tertiary);
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        /* Audio recording */
        #mic-button.recording {
            animation: pulse 1.5s infinite;
            background-color: var(--error-color);
            color: white;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        /* Dark Theme */
        body.dark-theme {
            --bg-color: #343541;
            --card-bg: #444654;
            --chat-user-bg: #40414f;
            --chat-assistant-bg: #444654;
            --text-color: #ececf1;
            --text-secondary: #acacbe;
            --text-tertiary: #8e8ea0;
            --border-color: #4d4d4f;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #sidebar {
                position: absolute;
                left: -100%;
                z-index: 1000;
                height: 100%;
            }

            #sidebar.open {
                left: 0;
            }

            #main-content {
                width: 100%;
            }

            .welcome-container {
                padding: 1rem;
            }

            .welcome-button {
                width: 100%;
            }

            .user-message,
            .assistant-message {
                padding: 1rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-file-alt"></i>
                    <span>DastavejWizard</span>
                </div>
            </div>
            <button id="new-chat-btn" class="sidebar-button">
                <i class="fas fa-plus"></i>
                <span>New chat</span>
            </button>

            <div class="sidebar-section">
                <div class="section-header">Recent chats</div>
                <div id="chat-list">
                    <div class="chat-item active">
                        <i class="fas fa-file-alt"></i>
                        <span>Document Q&A</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <button id="clear-convos" class="sidebar-button secondary">
                    <i class="fas fa-trash-alt"></i>
                    <span>Clear conversations</span>
                </button>
                <button id="toggle-theme" class="sidebar-button secondary">
                    <i class="fas fa-moon"></i>
                    <span>Toggle theme</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <header class="header-container">
                <button id="menu-toggle" class="header-menu-button">
                    <i class="fas fa-bars"></i>
                </button>
                <span class="header-title">DastavejWizard</span>
                <div id="file-badge" class="file-badge hidden">
                    <i class="fas fa-file-alt"></i>
                    <span id="file-name">No file</span>
                </div>
            </header>

            <!-- Chat Area -->
            <div id="chat-container">
                <div class="welcome-container" id="welcome-container">
                    <div class="welcome-header">
                        <i class="fas fa-file-alt logo-large"></i>
                        <h1>DastavejWizard</h1>
                        <p class="welcome-subtitle">Upload a document and ask questions about its content</p>
                    </div>
                    <div class="welcome-actions">
                        <button id="welcome-upload" class="welcome-button primary" >
                            <i class="fas fa-upload"></i>
                            <span>Upload document</span>
                        </button>
                        <input type="file" id="file-input" style="display: none;" />
                        <div id="spinner" style="display: none;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <div id="chatbot">
                    <!-- Chat messages will be inserted here -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div id="input-container">
                    <textarea id="message-input" placeholder="Message MultiLipi..." rows="1"></textarea>
                    <div class="input-buttons">
                        <button id="file-button" class="icon-button" title="Upload document">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <!-- <button id="mic-button" class="icon-button" title="Voice input">
                            <i class="fas fa-microphone"></i>
                        </button> -->
                        <button id="send-button" class="icon-button primary" title="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="input-footer">
                    <p>MultiLipi can make mistakes. Consider checking important information.</p>
                </div>

                <!-- Hidden Audio Element -->
                <div id="audio-container" class="hidden">
                    <audio id="audio-input" controls></audio>
                </div>

                <!-- Hidden File Upload -->
                <input type="file" id="file-upload" accept=".pdf,.jpg,.jpeg,.png,.json" class="hidden">
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const messageInput = document.getElementById("message-input");
            const sendButton = document.getElementById("send-button");
            const chatBotDiv = document.getElementById("chatbot");
            const chat = document.getElementById("chat-container");
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const menuToggle = document.getElementById('menu-toggle');
            const themeToggle = document.getElementById('toggle-theme');
            const chatbot = document.getElementById('chatbot');
            const fileButton = document.getElementById('file-button');
            const micButton = document.getElementById('mic-button');
            const fileUpload = document.getElementById('file-upload');
            const fileBadge = document.getElementById('file-badge');
            const fileName = document.getElementById('file-name');
            const newChatBtn = document.getElementById('new-chat-btn');
            const clearConvos = document.getElementById('clear-convos');
            const chatList = document.getElementById('chat-list');
            const welcomebutton = document.getElementById('welcome-upload');

            let uploadedFile = null;
            let recentChats = [];
            let isRecording = false;
            let mediaRecorder = null;
            let audioChunks = [];
            let currentTheme = localStorage.getItem('theme') || 'light';
            let uploadedFilePath = '';
            
            // Set initial theme
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-theme');
                updateThemeIcon(true);
            }

            // Theme Toggle
            themeToggle.addEventListener('click', function () {
                const isDark = document.body.classList.toggle('dark-theme');
                updateThemeIcon(isDark);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });


            function updateThemeIcon(isDark) {
                const icon = themeToggle.querySelector('i');
                if (isDark) {
                    icon.className = 'fas fa-sun';
                    themeToggle.querySelector('span').textContent = 'Light mode';
                } else {
                    icon.className = 'fas fa-moon';
                    themeToggle.querySelector('span').textContent = 'Dark mode';
                }
            }

            // Sidebar Toggle
            let isFullscreen = false;

            // Fullscreen toggle on double-click
            menuToggle.addEventListener('click', function () {
                const appContainer = document.querySelector('.app-container');
                appContainer.classList.toggle('fullscreen-mode');
            });

            // Responsive checks
            window.addEventListener('resize', function () {
                if (window.innerWidth > 768) {
                    sidebar.style.left = '0';
                } else if (!sidebar.classList.contains('open')) {
                    sidebar.style.left = '-100%';
                }
            });
            // Message input auto-resize
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';

                // Enable send button only if there's text
                if (this.value.trim()) {
                    sendButton.disabled = false;
                } else {
                    sendButton.disabled = true;
                }
            });

            // Initialize send button state
            sendButton.disabled = true;

            // Send message on Enter key
            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (this.value.trim()) {
                        sendMessage();
                    }
                }
            });
            
            function scrollToBottom() {
                chatBotDiv.scrollTop = chatBotDiv.scrollHeight;
            }

            async function sendMessage() {
                const userMessage = messageInput.value.trim();
                function scrollToBottom() {
                chatBotDiv.scrollTop = chatBotDiv.scrollHeight;
                }
                if (userMessage) {
                    // Display user message
                    chat.scrollTop = chat.scrollHeight;
                    const userMessageDiv = `
                <div class="chat-turn">
                    <div class="user-message">
                        <div class="message-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="message-content">
                            <p>${userMessage}</p>
                        </div>
                    </div>
                </div>
            `;
                    chatBotDiv.insertAdjacentHTML("beforeend", userMessageDiv);
                    messageInput.value = "";
                    scrollToBottom();

                    // Add a loading spinner for the assistant message
                    const loadingMessageDiv = `
                <div class="chat-turn assistant-turn">
                    <div class="assistant-message">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div id="spinner" style="display: block;">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                    chatBotDiv.insertAdjacentHTML("beforeend", loadingMessageDiv);
                    scrollToBottom();

                    try {
                        // Call the /chat route
                        const response = await fetch("/chat", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ message: userMessage }),
                        });

                        const data = await response.json();

                        // Find the last inserted spinner and replace it with the assistant's response
                        const loadingDiv = chatBotDiv.querySelector(".assistant-turn:last-child .message-content #spinner");
                        loadingDiv.parentElement.innerHTML = `
                    
                        <div class="message-content">
                            ${marked.parse(data.answer)}
                        </div>
                    
                `;
                        scrollToBottom();
                    } catch (error) {
                        console.error("Error fetching chat response:", error);
                    }
                }
            };
            sendButton.addEventListener("click", async () => {
                sendMessage();
                // const userMessage = messageInput.value.trim();

                // if (userMessage) {
                //     // Display user message
                //     chat.scrollTop = chat.scrollHeight;
                //     const userMessageDiv = `
                //         <div class="chat-turn">
                //             <div class="user-message">
                //                 <div class="message-avatar">
                //                     <i class="fas fa-user"></i>
                //                 </div>
                //                 <div class="message-content">
                //                     <p>${userMessage}</p>
                //                 </div>
                //             </div>
                //         </div>
                //     `;
                //     chatBotDiv.insertAdjacentHTML("beforeend", userMessageDiv);
                //     messageInput.value = "";
                //     scrollToBottom();

                //     // Add a loading spinner for the assistant message
                //     const loadingMessageDiv = `
                //         <div class="chat-turn assistant-turn">
                //             <div class="assistant-message">
                //                 <div class="message-avatar">
                //                     <i class="fas fa-robot"></i>
                //                 </div>
                //                 <div class="message-content">
                //                     <div id="spinner" style="display: block;">
                //                         <div class="spinner"></div>
                //                     </div>
                //                 </div>
                //             </div>
                //         </div>
                //     `;
                //     chatBotDiv.insertAdjacentHTML("beforeend", loadingMessageDiv);
                //     scrollToBottom();

                //     try {
                //         // Call the /chat route
                //         const response = await fetch("/chat", {
                //             method: "POST",
                //             headers: {
                //                 "Content-Type": "application/json",
                //             },
                //             body: JSON.stringify({ message: userMessage }),
                //         });

                //         const data = await response.json();

                //         // Find the last inserted spinner and replace it with the assistant's response
                //         const loadingDiv = chatBotDiv.querySelector(".assistant-turn:last-child .message-content #spinner");
                //         loadingDiv.parentElement.innerHTML = `

                //                 <div class="message-content">
                //                     ${marked.parse(data.answer)}
                //                 </div>

                //         `;
                //         scrollToBottom();
                //     } catch (error) {
                //         console.error("Error fetching chat response:", error);
                //     }
                // }
            });


           
            welcomebutton.addEventListener('click', function () {
                document.getElementById('file-input').click();
            });
            fileButton.addEventListener('click', function () {
                document.getElementById('file-input').click();
            });
            document.getElementById('file-input').addEventListener('change', async function () {
                const file = this.files[0];
                if (!file) return;
                const button = document.getElementById('welcome-upload');
                button.style.display = 'none';
                const formData = new FormData();
                formData.append('file', file);

                const spinner = document.getElementById('spinner');
                spinner.style.display = 'block';  // Show spinner

                try {
                    const response = await fetch('/', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(result);
                        updateTable(result.ans);
                        addRecentChat(file.name);
                    } else {
                        alert('Upload failed: ' + response.statusText);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    spinner.style.display = 'none';  // Hide spinner
                }
            });

            function updateTable(data) {
                const container = document.getElementById('welcome-container');

                // Clear any existing content in the container
                container.innerHTML = '';

                if (typeof data !== 'object' || data === null || Object.keys(data).length === 0) {
                    container.innerHTML = '<p>No data available</p>';
                    return;
                }

                // Create a table
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';

                // Create table header
                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                const th1 = document.createElement('th');
                th1.textContent = 'Departments';
                th1.style.backgroundColor = '#4CAF50';
                th1.style.color = 'white';
                th1.style.padding = '12px 15px';
                th1.style.textAlign = 'left';

                const th2 = document.createElement('th');
                th2.textContent = 'Problems';
                th2.style.backgroundColor = '#4CAF50';
                th2.style.color = 'white';
                th2.style.padding = '12px 15px';
                th2.style.textAlign = 'left';

                headerRow.appendChild(th1);
                headerRow.appendChild(th2);

                // Create table body
                const tbody = table.createTBody();
                Object.entries(data).forEach(([key, value]) => {
                    const row = tbody.insertRow();
                    row.style.borderBottom = '1px solid #ddd';

                    const td1 = row.insertCell();
                    td1.textContent = key;
                    td1.style.padding = '12px 15px';
                    td1.style.textAlign = 'left';

                    const td2 = row.insertCell();
                    td2.textContent = value;
                    td2.style.padding = '12px 15px';
                    td2.style.textAlign = 'left';
                });

                // Apply styles to table and container
                table.style.marginTop = '20px';
                table.style.fontFamily = 'Arial, sans-serif';
                table.style.fontSize = '14px';
                table.style.border = '1px solid #ddd';

                // Add zebra-striping effect for table rows
                Array.from(tbody.rows).forEach((row, index) => {
                    if (index % 2 === 0) {
                        row.style.backgroundColor = '#f9f9f9';
                    }
                });

                // Append the table to the container
                container.appendChild(table);
            }

            // micButton.addEventListener('click', toggleRecording);
            
            
            
            // mic not working
            // Function to toggle recording
            function toggleRecording() {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }

            // Function to start recording
            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        micButton.classList.remove('recording');
                        isRecording = false;

                        // Upload audioBlob to backend for transcription
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.webm');

                        try {
                            const res = await fetch(`/transcribe`, {
                                method: 'POST',
                                body: formData
                            });
                            const data = await res.json();

                            if (data && data.transcript) {
                                messageInput.value = data.transcript;
                                messageInput.dispatchEvent(new Event('input'));
                                messageInput.focus();
                            } else {
                                alert("Could not transcribe audio.");
                            }
                        } catch (err) {
                            console.error("Transcription error:", err);
                            alert("Error sending audio to backend.");
                        }
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    micButton.classList.add('recording');

                } catch (err) {
                    console.error("Error accessing microphone:", err);
                    alert("Microphone access denied or unavailable.");
                }
            }


            // Function to stop recording
            function stopRecording() {
                if (mediaRecorder && isRecording) {
                    mediaRecorder.stop();
                    isRecording = false;
                    micButton.classList.remove('recording');

                    // Stop all audio tracks
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
            }

            // Function to send a message
            
            function showTypingIndicator() {
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'message assistant typing';
                typingIndicator.id = 'typing-indicator';

                const bubble = document.createElement('div');
                bubble.className = 'typing-bubble';
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    bubble.appendChild(dot);
                }

                typingIndicator.appendChild(bubble);
                chatbot.appendChild(typingIndicator);
                chatbot.scrollTop = chatbot.scrollHeight;
            }

            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }




           
            // Function to add a chat to recent chats
            function addRecentChat(title) {
                // Add to memory
                const chatId = 'chat-' + Date.now();
                const chat = {
                    id: chatId,
                    title: title
                };

                recentChats.unshift(chat);

                // Store in local storage
                localStorage.setItem('recentChats', JSON.stringify(recentChats));

                // Update UI
                updateRecentChats();
            }

            // Function to update recent chats in sidebar
            function updateRecentChats() {
                chatList.innerHTML = '';

                if (recentChats.length === 0) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-chats';
                    emptyState.textContent = 'No recent chats';
                    chatList.appendChild(emptyState);
                    return;
                }

                recentChats.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.dataset.id = chat.id;

                    const chatTitle = document.createElement('div');
                    chatTitle.className = 'chat-title';
                    chatTitle.textContent = chat.title;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-chat';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';

                    deleteBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        deleteChat(chat.id);
                    });

                    chatItem.appendChild(chatTitle);
                    chatItem.appendChild(deleteBtn);

                    chatItem.addEventListener('click', function () {
                        loadChat(chat.id);
                    });

                    chatList.appendChild(chatItem);
                });
            }

            // Function to delete a chat
            function deleteChat(chatId) {
                recentChats = recentChats.filter(chat => chat.id !== chatId);
                localStorage.setItem('recentChats', JSON.stringify(recentChats));
                updateRecentChats();
            }

            // Function to load a chat
            async function loadChat(chatId) {
                const chat = recentChats.find(chat => chat.id === chatId);
                if (chat) {
                    uploadedFile = { name: chat.title };
                    fileName.textContent = uploadedFile.name;
                    fileBadge.classList.remove('hidden');
                    welcomeContainer.classList.add('hidden');

                    chatbot.innerHTML = '';

                    try {
                        const res = await fetch(`${API_BASE}/history/${chat.title}`);
                        console.log(res)
                        const history = await res.json();

                        console.log(history)

                        if (Array.isArray(history)) {
                            history.reverse().forEach(entry => {
                                addMessage(entry.question, 'user');
                                addMessage(entry.answer, 'assistant');
                            });
                        } else {
                            addMessage("Could not load chat history.", 'assistant');
                        }
                    } catch (err) {
                        console.error("Failed to load history:", err);
                        addMessage("Failed to fetch chat history from server.", 'assistant');
                    }
                }
            }

            // New chat button
            newChatBtn.addEventListener('click', function () {
                // Clear chat area
                chatbot.innerHTML = '';

                // Reset file
                uploadedFile = null;
                fileBadge.classList.add('hidden');

                // Show welcome screen
                welcomeContainer.classList.remove('hidden');
            });

            // Clear conversations button
            clearConvos.addEventListener('click', function () {
                if (confirm('Are you sure you want to clear all conversations?')) {
                    recentChats = [];
                    localStorage.removeItem('recentChats');
                    updateRecentChats();
                }
            });

            // Load recent chats from storage
            function loadRecentChats() {
                const savedChats = localStorage.getItem('recentChats');
                if (savedChats) {
                    try {
                        recentChats = JSON.parse(savedChats);
                        updateRecentChats();
                    } catch (e) {
                        console.error('Error loading recent chats:', e);
                        localStorage.removeItem('recentChats');
                    }
                }
            }

            // Initialize
            loadRecentChats();

            // If mobile, hide sidebar initially
            if (window.innerWidth <= 768) {
                sidebar.style.left = '-100%';
            };
        });
    </script>

</body>

</html>